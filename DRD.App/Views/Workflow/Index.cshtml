@using DRD.Models.View;
@model Layout

@{
    ViewBag.Title = "Workflow Detail";
    ViewBag.Submenu = "WORKFLOW";
}


@section Scripts
{
    <script src="/assets/vendors/file-upload/ng-file-upload-shim.min.js"></script> <!-- for no html5 browsers support -->
    <script src="/assets/vendors/file-upload/ng-file-upload.min.js"></script>

    

    <!--diagram-->
    <script src="/Scripts/flow/svg-path/leader-line.min.js"></script>
    <script src="~/Scripts/flow/svg-path/plain-draggable.min.js"></script>

    <script src="~/Scripts/flow/scripts/jquery-ui-1.10.4.custom.min.js" type="text/javascript"></script>

    <script type="text/javascript" src="~/Scripts/flow/dom-to-image.js"></script>
    <script type="text/javascript" src="/assets/filesaver/FileSaver.min.js"></script>

    <link href="~/Scripts/xflow/xdiagram.css" rel="stylesheet" type="text/css">

    <script src="~/Scripts/contextMenu/jquery.contextMenu.js" type="text/javascript"></script>

}
@section Styles{
    <link href="~/Scripts/contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
}

<!--/diagram-->

<body>
    <!-- Page container -->
    <div class="page-container" ng-controller="drdController" id="drdController">
        <div class="content-wrapper">
            <!-- Page header -->
            <h4>
                <a href="/workflow/list" class="btn btn-logo-header"><i class="icon-opt"></i></a> @ViewBag.Title
            </h4>

            <!-- /page header -->
            <!-- Horizontal form options -->
            <!-- Content area -->
            <div class="content" style="display:none">
                <!-- Basic layout-->
                <div class="panel panel-flat">
                    <div class="panel-body">
                        <!--MEMBER DATA-->
                        <form name="myForm" class="form-horizontal" autocomplete="off">
                            <div ng-show="wizarno=='product'">
                                <fieldset>
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <label class="control-label">Name</label>
                                                <div class="input-group">
                                                    <div>
                                                        <input type="text" class="form-control" ng-model="model.Name" ng-required="wizarno=='product'" maxlength="100"   disabled />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <br />
                                        <div class="row">

                                            <div class="col-md-10">
                                                <label class="control-label">Description</label>
                                                <br />
                                                <textarea disabled class="form-control control-label" ng-model="model.Description" rows="3" style="resize: none; overflow-y: hidden; opacity: 0.8; height: 100px;width:100%"></textarea>
                                            </div>
                                        </div>

                                        <div class="row" ng-show="isValidObject('ISTEMPLATE')">
                                            <div class="col-md-5">
                                                <label class="control-label">As Template</label>
                                                <br />
                                                <input id="checkbox2" type="checkbox" data-off-text="No&ensp;" data-on-text="Yes" class="BSswitch" ng-model="model.IsTemplate">
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                                <hr />
                                <!--CANVAS-->
                                <div id="xdiagramController" ng-controller="xdiagramController">
                                    <div class="modal-header bg-grey-300">
                                        <button id="downloadDiagam" class="close" type="button"><i class="icon-file-download pull-right"></i></button>
                                        <h6 class="modal-title">
                                            Canvas
                                            <span class="is-used" style="display:none">(Disabled)</span>
                                        </h6>
                                    </div>

                                    <div class="is-used alert alert-warning alert-styled-left" style="padding:5px;margin-bottom:0px;display:none">
                                            The diagram <span class="text-semibold">cannot be updated</span>, because it is already used by the rotation.
                                    </div>

                                    <div id="canvas" class="canvas context-menu-one" onscroll="canvasScroll()" ng-click="releaseAllSelected()" style="pointer-events:none">

                                        <div id="node-activity-xx" class="node-activity-yy" style="display:none">
                                            <div id="node-activity-caption-xx" class="node-activity-caption-yy">
                                                <i class="icon-cross3 pull-right" onclick="removeActivityConfirmation('-xx-')"></i>
                                                <i class="icon-loop4 pull-right" onclick="selectLink('node-activity-xx')" data-popup="tooltip" title="Select links" data-placement="bottom"></i>
                                            </div>
                                            <div style="width:100%;text-align:center;" class="node-activity-content-yy">
                                                <span id="title-activity-xx" class="title-activity">Activity</span>
                                            </div>
                                            <div class="footer-yy">
                                                <div id="submit-xx" class="join con-submit" data-popup="tooltip" title="Submit" data-placement="bottom"></div>
                                            </div>
                                        </div>


                                        <div id="start-0" class="terminator start" style="display:none">
                                            <span id="title-start-0" class="text-format">Start</span>
                                        </div>


                                        <div id="end-1" class="terminator end" style="display:none">
                                            <span id="title-end-1" class="text-format">End</span>
                                        </div>

                                        <div id="node-activity-2" class="node-activity-2" style="display:none">
                                            <div id="node-activity-caption-2" class="node-activity-caption-2">
                                                <span id="title-activity-2" class="title-activity">Document Uploading</span>
                                            </div>
                                            <div class="footer">
                                                <div id="submit-2" class="join con-submit" data-popup="tooltip" title="Start" data-placement="bottom"></div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <!--/CANVAS-->
                                <hr />
                                <div class="col-md-12">
                                    <div class="col-md-12">
                                        <div class="text-right">
                                            <button class="btn btn-drd-1-bordered  btn-large  pull-right btn-ladda btn-submit1" data-style="slide-down" data-spinner-color="#333" ng-click="deleteWorkflow()" style="width:120px">
                                                <span class="ladda-label">&nbsp;&nbsp;Delete&nbsp;&nbsp;</span><span class="ladda-spinner"></span>
                                                <div class="ladda-progress" style="width: 0px;"></div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!--/MEMBER DATA-->
                        <!--CONFIRMATION THANK YOU-->
                        <div ng-show="wizarno=='success'">
                            <div class="alert alert-success alert-styled-left">
                                Data successfully saved.
                                <br>
                            </div>
                            This page will be redirected to Rotation List page in 10 seconds
                        </div>
                        <!--/CONFIRMATION THANK YOU-->

                    </div>
                </div>
                <!-- /basic layout -->
            </div>
            <!-- /vertical form options -->
        </div>
    </div>
    <!-- /Page container -->


    <script type="text/javascript">
        var myApp = angular.module('drdApp', ['ngAnimate', 'ui.bootstrap', 'ngFileUpload'])
        myApp.controller("drdController", function ($scope, Upload, $http) {
            $scope.model = {};
            $scope.wizarno = 'product';
            $scope.master = {};
            $scope.model.IsActive=true;
            $scope.model.Id = 0;
            $scope.isUsed = false;
            $scope.objectItems=[];
            initValues();

            /*--------------------------------------------------------------
            INIT DATA
            --------------------------------------------------------------*/
            angular.element(document).ready(function () {

                if ($scope.model.Id!=0){
                    setTimeout(function () {
                        var digramScope=angular.element('#xdiagramController').scope();
                        digramScope.bindDiagram(digramScope.$parent.nodes, digramScope.$parent.links);
                        $("#start-0").show();
                        $("#end-1").show();
                        digramScope.refreshLines();
                    }, 500);
                }
                $(".content").show();
            });


            function initValues() {
                var product = @Html.Raw(Json.Encode(Model.Object));
                $scope.objectItems = @Html.Raw(Json.Encode(Model.ObjectItems));
                if (product.Id!=0 ){
                    $scope.model.Id=product.Id;
                    $scope.model.Name=product.Name;
                    $scope.model.Description= product.Description;
                    $scope.model.IsActive= product.IsActive;
                    $scope.model.IsTemplate= product.IsTemplate;
                    $scope.project=product.Project;
                    $scope.nodes=product.WorkflowNodes;
                    $scope.links=product.WorkflowNodeLinks;
                    $scope.isUsed=product.IsUsed;
                    if (!product.IsUsed)
                        $("#canvas").css("pointer-events",'');
                    else
                        $(".is-used").show();
                }else{
                    $("#canvas").css("pointer-events",'');
                }

            }
            $scope.initData = function () {
            }
            /*--------------------------------------------------------------
            SAVE PRODUCT
            --------------------------------------------------------------*/
            $scope.saveProduct = function () {
                var btn = Ladda.create(document.querySelector('.btn-submit1'));
                btn.start();
                var digramScope=angular.element('#xdiagramController').scope();
                var data = digramScope.submitFlow();
                
                $http.post('@Url.Action("Save", "Workflow")',
                    {
                        newWorkflow: {
                            Id: $scope.model.Id,
                            Name: $scope.model.Name,
                            Description: $scope.model.Description,
                            IsActive: true,
                            IsTemplate: false,
                            WorkflowNodes:data.nodes,
                            WorkflowNodeLinks:data.links,
                        }
                    }).then(function (response) {
                        btn.stop();
                        if (response.data) {
                            window.scrollTo(0, 0);
                            $.jGrowl('This Workflow has been saved', {
                                header: "Save Workflow",
                                //sticky: true,
                                life: $scope.notiftime,
                                theme: 'alert-styled-right bg-success'
                            });
                            digramScope.clearDiagram();
                        }
                    }, function (response) {
                            btn.stop();
                        //error handle\
                        var x = 0;
                    });

            }
            $scope.updateProduct = function () {
                if (!$scope.isValidForm($scope.myForm))
                    return;
                $scope.saveProduct();
            }
           
            $scope.isValidForm = function (theForm) {
                var isvalid = theForm.$valid;
                return isvalid;
            };
            $scope.scrollingPage = function (id) {
                $('html, body').animate({
                    scrollTop: $(id).offset().top
                }, 200);
            }

             $scope.deleteWorkflow = function () {
                var workflowId = $scope.model.Id;
                 $http.post('@Url.Action("DeleteWorkflow", "Workflow")',
                     {
                         id: workflowId
                     })
                    .then(function (response) {
                        if (response.data == "OK") {
                            $.jGrowl('This workflow has been deleted', {
                                header: "Delete Workflow",
                                //sticky: true,
                                life: $scope.notiftime,
                                theme: 'alert-styled-right bg-info'
                            });
                            window.location.href = 'workflow/list';
                        } else if(response.data == "NOT_FOUND") {
                            $.jGrowl('Workflow not found', {
                                header: "Delete failed",
                                //sticky: true,
                                life: $scope.notiftime,
                                theme: 'alert-styled-right bg-danger'
                            });
                        }
                         else if(response.data == "USED_IN_ROTATION") {
                            $.jGrowl('Workflow has already been used in rotation', {
                                header: "Delete failed",
                                //sticky: true,
                                life: $scope.notiftime,
                                theme: 'alert-styled-right bg-danger'
                            });
                        }
                    });
            }
        });
        $(document).ready(function () {

            $(window).keydown(function(event){
                if(event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });

            //var node = document.getElementById('canvas');
            var btn = document.getElementById('downloadDiagam');
            btn.onclick = function() {
                domtoimage.toBlob(document.getElementById('canvas'))
                    .then(function(blob) {
                        window.saveAs(blob, 'my-node.png');
                    });
            }
        })
        // this function is to convert blob to base64 img
        function saveBlobAsFile(blob, fileName) {
            var reader = new FileReader();
            reader.onloadend = function() {
                var base64 = reader.result;
                var img = document.createElement("img");
                img.classList.add("me-img");
                img.setAttribute("src", base64);
                // insert the img to dom
                document.getElementById("bar").appendChild(img);
            };
            reader.readAsDataURL(blob);
        }
    </script>
    <script src="/Scripts/xcontroller/xdiagram.js" type="text/javascript"></script>
</body>