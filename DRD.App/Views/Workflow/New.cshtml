
@using DRD.Models.View;
@model Layout

@{
    ViewBag.Title = "Create a New Workflow";
    ViewBag.Submenu = "WORKFLOW";
}

@section Scripts
{
    <script src="/assets/vendors/file-upload/ng-file-upload-shim.min.js"></script> <!-- for no html5 browsers support -->
    <script src="/assets/vendors/file-upload/ng-file-upload.min.js"></script>

    

    <!--diagram-->
    <script src="/Scripts/flow/svg-path/leader-line.min.js"></script>
    <script src="~/Scripts/flow/svg-path/plain-draggable.min.js"></script>

    <script src="~/Scripts/flow/scripts/jquery-ui-1.10.4.custom.min.js" type="text/javascript"></script>

    <script type="text/javascript" src="~/Scripts/flow/dom-to-image.js"></script>
    <script type="text/javascript" src="/assets/filesaver/FileSaver.min.js"></script>

    <link href="~/Scripts/xflow/xdiagram.css" rel="stylesheet" type="text/css">

    <script src="~/Scripts/contextMenu/jquery.contextMenu.js" type="text/javascript"></script>

}
@section Styles{
    <link href="~/Scripts/contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
}

<!--/diagram-->


<body>
    <!-- Page container -->
    <div class="page-container" ng-controller="drdController" id="drdController">
            <div class="content-wrapper">
                <!-- Page header -->
                <h4>
                    <a href="/workflow/list" class="btn btn-logo-header"><i class="icon-opt"></i></a> @ViewBag.Title
                </h4>

                <!-- /page header -->
                <!-- Horizontal form options -->
                <!-- Content area -->
                <div class="content" style="display:none">
                    <!-- Basic layout-->
                    <div class="panel panel-flat">
                        <div class="panel-body">
                            <!--MEMBER DATA-->
                            <form name="myForm" class="form-horizontal" autocomplete="off">
                                <div ng-show="wizarno=='product'">
                                    <fieldset>
                                        <div class="col-md-12">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label class="control-label">Name</label>
                                                    <input type="text" class="form-control" ng-model="model.Name" ng-required="wizarno=='product'" maxlength="100" />
                                                </div>
                                            </div>
                                            <br/>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label class="control-label">Description</label>
                                                    <br />
                                                    <textarea class="form-control control-label" ng-model="model.Description" rows="3" style="resize: none; overflow-y: hidden; opacity: 0.8; height: 100px;width:100%"></textarea>
                                                </div>
                                            </div>

                                            <div class="row" ng-show="isValidObject('ISTEMPLATE')">
                                                <div class="col-md-5">
                                                    <label class="control-label">As Template</label>
                                                    <br />
                                                    <input id="checkbox2" type="checkbox" data-off-text="No&ensp;" data-on-text="Yes" class="BSswitch" ng-model="model.IsTemplate">
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                    <hr />
                                    <!--CANVAS-->
                                    <div id="xdiagramController" ng-controller="xdiagramController">
                                        <div class="modal-header bg-grey-300">
                                            <button id="downloadDiagam" class="close" type="button"><i class="icon-file-download pull-right"></i></button>
                                            <h6 class="modal-title">
                                                Canvas
                                                <span class="is-used" style="display:none">(Disabled)</span>
                                            </h6>
                                        </div>

                                        <div id="canvas" class="canvas context-menu-one" onscroll="canvasScroll()" ng-click="releaseAllSelected()" style="pointer-events:none">

                                            <div id="node-activity-xx" class="node-activity-yy" style="display:none">
                                                <div id="node-activity-caption-xx" class="node-activity-caption-yy">
                                                    <i class="icon-cross3 pull-right" onclick="removeActivityConfirmation('-xx-')"></i>
                                                    <i class="icon-loop4 pull-right" onclick="selectLink('node-activity-xx')" data-popup="tooltip" title="Select links" data-placement="bottom"></i>
                                                </div>
                                                <div style="width:100%;text-align:center;" class="node-activity-content-yy">
                                                    <span id="title-activity-xx" class="title-activity">ActivTitle</span>
                                                </div>
                                                <div class="footer-yy">
                                                    <div id="submit-xx" class="join con-submit" data-popup="tooltip" title="Submit" data-placement="bottom"></div>
                                                </div>
                                            </div>


                                            <div id="start-0" class="terminator start" style="display:none">
                                                <span id="title-start-0" class="text-format">Start</span>
                                            </div>


                                            <div id="end-1" class="terminator end" style="display:none">
                                                <span id="title-end-1" class="text-format">End</span>
                                            </div>

                                            <div id="node-activity-2" class="node-activity-2" style="display:none">
                                                <div id="node-activity-caption-2" class="node-activity-caption-2">
                                                    <span id="title-activity-2" class="title-activity">Document Uploading</span>
                                                </div>
                                                <div class="footer">
                                                    <div id="submit-2" class="join con-submit" data-popup="tooltip" title="Start" data-placement="bottom"></div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <!--/CANVAS-->
                                    <hr />
                                    <div class="col-md-12">
                                        <div class="col-md-12">
                                            <div class="text-right">
                                                <button class="btn btn-drd-1 btn-large pull-right btn-ladda btn-submit1" data-style="slide-down" data-spinner-color="#333" ng-click="updateProduct()" style="width:120px">
                                                    <span class="ladda-label">&nbsp;&nbsp;Add Workflow&nbsp;&nbsp;</span><span class="ladda-spinner"></span>
                                                    <div class="ladda-progress" style="width: 0px;"></div>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!--/MEMBER DATA-->
                            <!--CONFIRMATION THANK YOU-->
                            <div ng-show="wizarno=='success'">
                                <div class="alert alert-success alert-styled-left">
                                    Data successfully saved.
                                    <br>
                                </div>
                                This page will be redirected to Workflow List page 
                            </div>
                            <!--/CONFIRMATION THANK YOU-->

                        </div>
                    </div>
                    <!-- /basic layout -->
                </div>
                <!-- /vertical form options -->
            </div>
    </div>
    <!-- /Page container -->

    <script type="text/javascript">
    var myApp = angular.module('drdApp', ['ngAnimate', 'ui.bootstrap','ngFileUpload'])
    myApp.controller("drdController", function ($scope, Upload, $http) {
        $scope.model = {};
        $scope.wizarno = 'product';
        $scope.master = {};
        $scope.model.IsActive=true;
        $scope.model.Id = 0;
        $scope.isUsed = false;
        $scope.objectItems=[];
        initValues();


        /*--------------------------------------------------------------
        INIT DATA
        --------------------------------------------------------------*/
        angular.element(document).ready(function () {
            $("#start-0").show();
            $("#end-1").show();
            $(".content").show();
        });


        function initValues() {
            $("#canvas").css("pointer-events",'');
        }
        /*--------------------------------------------------------------
        SAVE PRODUCT
        --------------------------------------------------------------*/
        $scope.updateProduct = function () {
            if (!$scope.isValidForm($scope.myForm))
                return;
            $scope.saveProduct();
        }

        $scope.isValidForm = function (theForm) {
            var isvalid = theForm.$valid;
            return isvalid;
        };

        $scope.saveProduct = function () {
            var btn = Ladda.create(document.querySelector('.btn-submit1'));
            btn.start();
            var digramScope=angular.element('#xdiagramController').scope();
            var data = digramScope.submitFlow();
            console.log(data);

            $http.post('@Url.Action("Save", "Workflow")',
                {
                    newWorkflow: {
                        Id: $scope.model.Id,
                        Name: $scope.model.Name,
                        Description: $scope.model.Description,
                        IsActive: true,
                        IsTemplate: false,
                        WorkflowNodes:data.nodes,
                        WorkflowNodeLinks:data.links,
                    }
                }).then(function (response) {
                    btn.stop();
                    if (response.data) {
                        if (response.data == -1) { showInfo("The amount of activity created exceeds the number of your package. Please see your default plan type at My account -> My Plan Type"); return; }
                        else if (response.data == -2) { showInfo("You do not have a plan payment."); return; }
                        else if (response.data == -3) { showInfo("This workflow can not be edit because it already in use"); return; }

                        window.scrollTo(0, 0);
                        $scope.wizarno = 'success';
                        digramScope.clearDiagram();
                        setTimeout(function () {
                                window.location.href = "/workflow/list";
                            }, 1000);
                    }
                }, function (response) {
                        btn.stop();
                    //error handle\
                    var x = 0;
                });

        }


        $scope.scrollingPage = function (id) {
            $('html, body').animate({
                scrollTop: $(id).offset().top
            }, 200);
        }


    });
    $(document).ready(function () {

        $(window).keydown(function(event){
            if(event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        });

        //var node = document.getElementById('canvas');
        var btn = document.getElementById('downloadDiagam');
        btn.onclick = function() {
            domtoimage.toBlob(document.getElementById('canvas'))
                .then(function(blob) {
                    window.saveAs(blob, 'my-node.png');
                });
        }
    })
    // this function is to convert blob to base64 img
    function saveBlobAsFile(blob, fileName) {
        var reader = new FileReader();
        reader.onloadend = function() {
            var base64 = reader.result;
            var img = document.createElement("img");
            img.classList.add("me-img");
            img.setAttribute("src", base64);
            // insert the img to dom
            document.getElementById("bar").appendChild(img);
        };
        reader.readAsDataURL(blob);
    }
    </script>
    <script src="/Scripts/xcontroller/xdiagram.js" type="text/javascript"></script>
</body>