@using DRD.Domain;
@model JsonLayout
@{
    Layout = null;
}

<link rel="stylesheet" href="/assets/css/demo.css">
<link rel="stylesheet" href="/assets/css/header-user-dropdown.css">
<link href='http://fonts.googleapis.com/css?family=Cookie' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="/css/main.css">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700,900" rel="stylesheet"
      type="text/css">
<link href="/assets/css/icons/icomoon/styles.css" rel="stylesheet" type="text/css">
<link href="/assets/css/icons/fontawesome/styles.min.css" rel="stylesheet" type="text/css">
@*<link href="/assets/css/bootstrap.css" rel="stylesheet" type="text/css">*@
<link href="/assets/css/core.css" rel="stylesheet" type="text/css">
<link href="/assets/css/components.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colors.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="/assets/js/plugins/loaders/pace.min.js"></script>
<script type="text/javascript" src="/assets/js/core/libraries/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/core/libraries/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/js/plugins/loaders/blockui.min.js"></script>




@*<script src="~/Scripts/pdf.js/build/pdf.worker.js" type="text/javascript"></script>*@


@*<script src="/assets/js/plugins/buttons/spin.min.js" type="text/javascript"></script>
    <script src="/assets/js/plugins/buttons/ladda.min.js" type="text/javascript"></script>
    <script src="/assets/js/pages/components_buttons.js" type="text/javascript"></script>*@

<script src="/assets/vendors/angular-1.5.5/angular.js"></script>
<script src="/assets/vendors/angular-1.5.5/angular-animate.js"></script>
<script src="/Scripts/ui-bootstrap-tpls-1.3.2.js"></script>

<script src="/assets/vendors/file-upload/ng-file-upload-shim.min.js"></script>
<script src="/assets/vendors/file-upload/ng-file-upload.min.js"></script>
<script src="/assets/vendors/ng_only_number.js"></script>

<script src="/assets/vendors/angular-1.5.5/angular-sanitize.min.js"></script>

@*http://bootstrapswitch.com/*@
@*<link href="/assets/vendors/bootstrap-switch/bootstrap3/bootstrap-switch.css" rel="stylesheet" type="text/css" />
    <script src="/assets/vendors/bootstrap-switch/bootstrap-switch.js"></script>*@

@* demo/doc https://uxsolutions.github.io/bootstrap-datepicker/?markup=input&format=&weekStart=&startDate=&endDate=&startView=0&minViewMode=0&maxViewMode=4&todayBtn=false&clearBtn=false&language=en&orientation=auto&multidate=&multidateSeparator=&autoclose=on&keyboardNavigation=on&forceParse=on#sandbox*@
@*<link id="bsdp-css" href="/assets/vendors/bootstrap-datepicker-1.6.4-dist/css/bootstrap-datepicker3.min.css" rel="stylesheet">
    <script src="/assets/vendors/bootstrap-datepicker-1.6.4-dist/js/bootstrap-datepicker.min.js"></script>*@

<script type="text/javascript" src="/assets/js/plugins/notifications/bootbox.min.js"></script>
<script type="text/javascript" src="/assets/js/plugins/notifications/sweet_alert.min.js"></script>

<script type="text/javascript" src="/assets/js/plugins/forms/styling/uniform.min.js"></script>
<script type="text/javascript" src="/assets/js/plugins/forms/styling/switchery.min.js"></script>
<script type="text/javascript" src="/assets/js/plugins/forms/styling/switch.min.js"></script>

@*<script src="~/Scripts/xpublic.js"></script>*@


@*<script src="~/Scripts/require.js"></script>*@

<link rel="stylesheet" href="/Scripts/pdf.js/web/viewer.css">

<!-- This snippet is used in production (included from viewer.html) -->
@*<link rel="resource" type="application/l10n" href="/Scripts/pdf.js/web/locale/locale.properties">*@
<script src="/Scripts/pdf.js/build/pdf.js"></script>
@*<script src="/Scripts/pdf.js/build/pdf.worker.js"></script>*@
<script src="/Scripts/pdf.js/web/viewer.js"></script>
@*<script> var exports = {}; </script>
    <script type="module"  src="~/Scripts/pdf.js.2.0.943/lib/web/annotation_layer_builder.js"></script>*@
<script type="text/javascript" src="~/Scripts/xpdf/MoveAndResizeTool.js"></script>
@*<script src="~/Scripts/flow/svg-path/plain-draggable.min.js"></script>*@
<script src="~/Scripts/flow/scripts/jquery-ui-1.10.4.custom.min.js" type="text/javascript"></script>
<style type="text/css">
    
    

    .svg-selection{
        user-select: none;
        pointer-events: none;
        position: absolute;
        touch-action: none;
    }

    .rect-selection{
        fill: transparent;
        stroke: rgba(60,151,254,.5);
        shape-rendering: crispEdges;
        cursor: pointer;
        pointer-events: fill;
    }

    .circle-selection{
        
        fill: #3c97fe;
        stroke: #fff;
        pointer-events: fill;
    }

    .resize-cursor-topleft{cursor: nwse-resize;}
    .resize-cursor-topcenter{cursor: ns-resize;}
    .resize-cursor-topright{cursor: nesw-resize;}

    .resize-cursor-bottomleft{cursor: nesw-resize;}
    .resize-cursor-bottomcenter{cursor: ns-resize;}
    .resize-cursor-bottomright{cursor: nwse-resize;}

    .resize-cursor-left{cursor: ew-resize;}
    .resize-cursor-right{cursor: ew-resize;}


    .text-tool{
        /*user-select: none;
        pointer-events: none;*/
        position: absolute;
        /*touch-action: none;*/
    }

    .signature{
        position:absolute;
        padding:4px;
        font-size:xx-small;
        font-family:Arial;
        background-color:yellow;
        border:solid;
        border-width:1px;
        min-width:150px;
        min-height:40px;
        cursor:pointer;
        pointer-events: stroke;
    }

    .initial{
        position:absolute;
        padding:4px;
        font-size:xx-small;
        font-family:Arial;
        background-color:greenyellow;
        border:solid;
        border-width:1px;
        min-width:150px;
        min-height:40px;
        cursor:pointer;
        pointer-events: stroke;
    }
    .stamp{
        position:absolute;
        padding:4px;
        /*min-width:150px;*/
        min-height:40px;
        cursor:pointer;
        pointer-events: stroke;
    }
</style>



<body ng-app="drdApp">

    <!-- Page container -->
    <div class="page-container" ng-controller="drdController" id="drdController">


        <!-- Page content -->
        <div class="page-content">


            <!-- Main content -->
            <div class="content-wrapper">
                <!-- Page header -->
                <div class="page-header page-header-default">
                    <div class="page-header-content">
                        <div class="page-title">
                            <h4>@*<i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Home</span> -*@ Data Dokumen</h4>
                            <span style="font-size:small">Entry data dokumen @*| <a href="/home/productlist">Kembali ke list</a>*@</span>
                        </div>

                    </div>

                </div>
                <!-- /page header -->
                <!-- Horizontal form options -->
                <!-- Content area -->
                <div class="content" @*style="display:none"*@>

                    <!-- Basic layout-->
                    <div class="panel panel-flat">

                        <div class="panel-body" style="height:500px;padding:0px;background-color:grey">
                            <ng-include src="'/Include/PdfViewer'" onload="finishLoading()"></ng-include>

                            <table id="signature-xx" class="signature" style="top:4px;left:4px;width:150px;height:40px;display:none;" onclick="annoSelector('signature-xx')">
                                <tr style="font-size:6pt;vertical-align:top">
                                    <td style="width:20px" rowspan="2">
                                        <img src="/Images/Member/icon_user.png" width="20" align="top"/>
                                    </td>
                                    <td style="height:10px;"><b>Signature</b></td>
                                </tr>
                                <tr style="font-size:6pt;vertical-align:top">
                                    <td>Approver</td>
                                </tr>
                            </table>
                            <table id="initial-xx" class="initial" style="top:4px;left:4px;width:150px;height:40px;display:none;" onclick="annoSelector('initial-xx')">
                                <tr style="font-size:6pt;vertical-align:top">
                                    <td style="width:20px" rowspan="2">
                                        <img src="/Images/Member/icon_user.png" width="20" align="top"/>
                                    </td>
                                    <td style="height:10px"><b>Initial</b></td>
                                </tr>
                                <tr style="font-size:6pt;vertical-align:top">
                                    <td>Approver</td>
                                </tr>
                            </table>

                            <svg class="svg-selection" id="svg-selection" style="left: 0px; top: 0px; width: 64px; height: 55px;display:none;z-index:1000;">
                                <rect class="rect-selection" id="rect-selection" x="4" y="4" width="50" height="41" style="stroke-width: 2; background-color:antiquewhite;opacity:0.2"></rect>
                                <circle cx="4" cy="4" r="4" stroke-width="1" class="circle-selection resize-cursor-topleft" title="Resize top left"></circle>
                                <circle cx="32" cy="4" r="4" stroke-width="1" class="circle-selection resize-cursor-topcenter" title="Resize top"></circle>
                                <circle cx="57" cy="4" r="4" stroke-width="1" class="circle-selection resize-cursor-topright" title="Resize top right"></circle>
                                <circle cx="57" cy="27.5" r="4" stroke-width="1" class="circle-selection resize-cursor-right" title="Resize right"></circle>
                                <circle cx="57" cy="48" r="4" stroke-width="1" class="circle-selection resize-cursor-bottomright" title="Resize bottom right"></circle>
                                <circle cx="32" cy="48" r="4" stroke-width="1" class="circle-selection resize-cursor-bottomcenter" title="Resize bottom"></circle>
                                <circle cx="4" cy="48" r="4" stroke-width="1" class="circle-selection resize-cursor-bottomleft" title="Resize bottom left"></circle>
                                <circle cx="4" cy="27.5" r="4" stroke-width="1" class="circle-selection resize-cursor-left" title="Resize left"></circle>
                                
                            </svg>
                        </div>
                    </div>
                    <!-- /basic layout -->
                </div>
                <!-- /vertical form options -->
            </div>
            <!-- /Main content -->
        </div>
        <!-- /Page content -->
    </div>

    
    <!-- /Page container -->

    <script type="text/javascript">


        var myApp = angular.module('drdApp', ['ngAnimate', 'ui.bootstrap', 'ngSanitize', 'ngFileUpload', 'ngOnlyNumberApp'])


        myApp.controller("drdController", function ($scope, $sce, Upload, $location, $http, $filter) {

            /*--------------------------------------------------------------
            INIT DATA
            --------------------------------------------------------------*/
            var annoLayerClass = "xannoLayer";
            var editTextClass = "text-tool";
            var signatureClass = "signature";
            var initialClass = "initial";
            var stampClass = "stamp";
            var penClass = "pen";
            var svgPadding = 4.;
            var toolType = 0;
            var clickedPage = 1;

            var strokeWidth = 5;
            var bufferSize = 4;

            var svgElement;
            var rect = {};
            var path = null;
            var strPath;
            var colorDefault = 'red';
            var colorPen = 'red';
            var colorHighlight = 'orange';
            var opacityColor = "1";
            var lineStraight = false;
            var buffer = []; // Contains the last positions of the mouse cursor
            var svgNo = 0;
            var edittextNo = 0;
            var signatureNo = 0;
            var initialNo = 0;
            var stampNo = 0;
            var penNo = 0;
            var selectedNodeId;
            var lastMouseX = 0;
            var lastMouseY = 0;
            var selectedMouseDown;
            var isresize = false;
            var isselector = false;
            var penWidth = 4;
            var highlighterWidth = 12;

            angular.element(document).ready(function () {
                
            });

            function initValues() {
            }

            $scope.initData = function () {
            }
            
            $scope.clickPointer = function () {
                toolType = 0;
            }

            $scope.clickPen = function (isStraight) {
                toolType = pdfjsLib.AnnotationType.LINE;
                var annolayer = createAnnoLayer(1);
                var svg = '<svg id="svg' + svgNo + '" class="svg" style="position:absolute; top:0px; left:0px;width:100%;height:100%"></svg>';
                strokeWidth = penWidth;
                colorDefault = colorPen;
                opacityColor = "1";
                lineStraight = isStraight;
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("mousedown", penMouseDown);
                svgElement.addEventListener("mousemove", penMouseMove);
                svgElement.addEventListener("mouseup", penMouseUp);
            }

            $scope.clickHighlight = function (isStraight) {
                toolType = pdfjsLib.AnnotationType.HIGHLIGHT;
                var annolayer = createAnnoLayer(1);
                var svg = '<svg id="svg' + svgNo + '" class="svg" style="position:absolute; top:0px; left:0px;width:100%;height:100%"></svg>';
                strokeWidth = highlighterWidth;
                colorDefault = colorHighlight;
                opacityColor = "0.4";
                lineStraight = isStraight;
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("mousedown", penMouseDown);
                svgElement.addEventListener("mousemove", penMouseMove);
                svgElement.addEventListener("mouseup", penMouseUp);
            }

            $scope.clickText = function () {
                toolType = pdfjsLib.AnnotationType.TEXT;

                var annolayer = createAnnoLayer(1);
                var svg = '<div id="svg' + svgNo + '" style="position:absolute; top:0px; left:0px; width:100%; height:100%;"></div>';
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("click", textMouseClick);
            }

            $scope.clickSignature = function () {
                toolType = pdfjsLib.AnnotationType.STAMP;

                var annolayer = createAnnoLayer(1);
                var svg = '<div id="svg' + svgNo + '" style="position:absolute; top:0px; left:0px; width:100%; height:100%;"></div>';
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("click", signatureMouseClick);
            }
            $scope.clickInitial = function () {
                toolType = pdfjsLib.AnnotationType.STAMP;

                var annolayer = createAnnoLayer(1);
                var svg = '<div id="svg' + svgNo + '" style="position:absolute; top:0px; left:0px; width:100%; height:100%;"></div>';
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("click", initialMouseClick);
            }
            $scope.clickStamp = function () {
                toolType = pdfjsLib.AnnotationType.STAMP;

                var annolayer = createAnnoLayer(1);
                var svg = '<div id="svg' + svgNo + '" style="position:absolute; top:0px; left:0px; width:100%; height:100%;"></div>';
                annolayer.append(svg);
                enableAnnoLayer(true);
                svgElement = document.getElementById("svg" + svgNo++);

                svgElement.addEventListener("click", stampMouseClick);
            }

            $scope.annoSelector = function (id) {
                selectedNodeId = id;
                
                var parent = $("#" + selectedNodeId).parent()[0].id
                svgElement = document.getElementById(parent);

                //WrapWithMoveAndResizeTool("#" + parent);
                $scope.annoSelectorCreateEvent();
                $scope.repositionSelector(id);

                if (id.startsWith(editTextClass)) {
                    $('#' + id).blur();
                }

                //dragElement(document.getElementById("svg-selection"));

            }

            $scope.repositionSelector = function (id) {
                var node = $('#' + id)[0];
                var parent = node.parentNode.parentNode;
                //if (node.classList[0] == 'svg')
                //    parent = node;
                var sel = $('.svg-selection').prependTo('#' + parent.id);
                var selector = $('.svg-selection').show();

                var svg = document.getElementById(id);
                svg = svg.parentNode;
                var rect = svg.getBoundingClientRect();

                var w = rect.width + (svgPadding * 2);
                var h = rect.height + (svgPadding * 2);

                selector.css({ "width": w + 'px' })
                selector.css({ "height": h + 'px' });

                var top = svg.offsetTop;
                var left = svg.offsetLeft;
                if (left == undefined)
                    left = pos2Float($('#' + svg.id).css('left'));
                if (top == undefined)
                    top = pos2Float($('#' + svg.id).css('top'));

                selector.css({ 'top': top - svgPadding + 'px' });
                selector.css({ 'left': left - svgPadding + 'px' });

                var tagrect = $('.svg-selection > rect');
                tagrect.attr('width', w - (svgPadding * 2));
                tagrect.attr('height', h - (svgPadding * 2));

                var rectattr = tagrect[0].attributes;
                w = parseFloat(rectattr.width.value) + svgPadding;
                h = parseFloat(rectattr.height.value) + svgPadding

                $('.resize-cursor-topcenter').attr('cx', (w / 2) + (svgPadding / 2));
                $('.resize-cursor-topright').attr('cx', w);
                $('.resize-cursor-right').attr('cx', w);
                $('.resize-cursor-right').attr('cy', (h / 2) + (svgPadding / 2));
                $('.resize-cursor-left').attr('cy', (h / 2) + (svgPadding / 2));

                $('.resize-cursor-bottomright').attr('cx', w);
                $('.resize-cursor-bottomright').attr('cy', h);

                $('.resize-cursor-bottomcenter').attr('cx', (w / 2) + (svgPadding / 2));
                $('.resize-cursor-bottomcenter').attr('cy', h);

                $('.resize-cursor-bottomleft').attr('cy', h);
            }

            $scope.annoSelectorCreateEvent = function () {
                $(".circle-selection").bind("mousedown", selectorMouseDown);
                $(document).bind("mousemove", selectorMouseMove);
                $(document).bind("mouseup", selectorMouseUp);
                $(document).bind("mousedown", documentMouseDown);
                $('.rect-selection').bind("dblclick", selectionDblClick);
            }
            $scope.annoSelectorRemoveEvent = function () {
                $(".circle-selection").unbind("mousedown", selectorMouseDown);
                $(document).unbind("mousemove", selectorMouseMove);
                $(document).unbind("mouseup", selectorMouseUp);
                $(document).unbind("mousedown", documentMouseDown);
                $('.rect-selection').unbind("dblclick", selectionDblClick);
            }

            var pos2Float = function (pos) {
                return parseFloat(pos.replace('px', ''))
            }
            var setWidthHeight = function(id, w, h, x, y)
            {
                var selected = $('#' + id);
                var theClass = selected[0].classList[0];
                //if (selected[0].classList[0] == 'pen') {
                //    theClass = selected[0].parentNode.classList[0];
                //}
                var minW = selected.css('min-width');
                var minH = selected.css('min-height');
                if (minW != undefined)
                    minW = pos2Float(minW);
                else
                    minW = 0;
                if (minH != undefined)
                    minH = pos2Float(minH);
                else
                    minH = 0;

                var posX = x;
                var posY = y;
                if (x != null && minW > w)
                    posX = null;
                else if (w != null && selected[0].classList[0] != 'pen')
                    selected.css({ "width": w + 'px' });

                if (y != null && minH > h)
                    posY = null;
                else if (h != null && selected[0].classList[0] != 'pen')
                    selected.css({ "height": h + 'px' });

                positionArrange(theClass, posX, posY);
            }

            var getHeight = function(id){
                if (id.height == undefined || id.height == '') {
                    if (id.offsetHeight == undefined) {
                        var rect = id.getBoundingClientRect();
                        return rect.height;
                    }
                    return id.offsetHeight;
                } else
                    return id.height;
            }
            var getWidth = function (id) {
                if (id.width == undefined || id.width == '') {
                    if (id.offsetWidth == undefined) {
                        var rect = id.getBoundingClientRect();
                        return rect.width;
                    }
                    return id.offsetWidth;
                } else
                    return id.width;
            }

            var documentMouseDown = function (event) {
                if (isselector || event.target.classList[0] == 'rect-selection') return;
                $scope.annoSelectorRemoveEvent();
                $('.svg-selection').hide();
                isresize = false;
            }
            var selectorMouseDown = function (event) {
                isselector = true;
                selectedMouseDown = event.target.classList[1];
                isresize = true;

                var selected = $('#' + selectedNodeId);

                console.log(selected[0].offsetHeight);
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
            }
            var selectorMouseMove = function (event) {
                if (!isresize) return;
                var currMouseX = event.clientX;
                var currMouseY = event.clientY;

                var deltaX = currMouseX - lastMouseX;
                var deltaY = currMouseY - lastMouseY;

                //this.applyMouseMoveAction(deltaX, deltaY);

                lastMouseX = event.pageX;
                lastMouseY = event.pageY;

                var selected = $('#' + selectedNodeId);
                if (selectedMouseDown == 'resize-cursor-topleft') {
                    setWidthHeight(selectedNodeId, 
                        getWidth(selected[0]) - deltaX,
                        getHeight(selected[0]) - deltaY,
                        selected[0].parentNode.offsetLeft + deltaX,
                        selected[0].parentNode.offsetTop + deltaY);
                } else if (selectedMouseDown == 'resize-cursor-topcenter') {
                    setWidthHeight(selectedNodeId, null, getHeight(selected[0]) - deltaY,
                        null, selected[0].parentNode.offsetTop + deltaY);
                } if (selectedMouseDown == 'resize-cursor-topright') {
                    setWidthHeight(selectedNodeId,
                        getWidth(selected[0]) + deltaX,
                        getHeight(selected[0]) - deltaY,
                        null, selected[0].parentNode.offsetTop + deltaY);
                } if (selectedMouseDown == 'resize-cursor-right') {
                    setWidthHeight(selectedNodeId, getWidth(selected[0]) + deltaX, null, null, null);
                } if (selectedMouseDown == 'resize-cursor-bottomright') {
                    setWidthHeight(selectedNodeId,
                        getWidth(selected[0]) + deltaX,
                        getHeight(selected[0]) + deltaY,
                        null, null);
                } if (selectedMouseDown == 'resize-cursor-bottomcenter') {
                    setWidthHeight(selectedNodeId, null, getHeight(selected[0]) + deltaY, null, null);
                } if (selectedMouseDown == 'resize-cursor-bottomleft') {
                    setWidthHeight(selectedNodeId,
                        getWidth(selected[0]) - deltaX,
                        getHeight(selected[0]) + deltaY,
                        selected[0].parentNode.offsetLeft + deltaX, null);
                } if (selectedMouseDown == 'resize-cursor-left') {
                    setWidthHeight(selectedNodeId, getWidth(selected[0]) - deltaX, null,
                        selected[0].parentNode.offsetLeft + deltaX, null);
                }
                console.log(selected[0].offsetHeight + ' ' + +deltaY + ' ' + currMouseY +' '+ lastMouseY);
                
                $scope.repositionSelector(selectedNodeId);
            }
            var selectorMouseUp = function (event) {
                isresize = false;
                isselector = false;
            }

            var createAnnoLayers = function(numPages)
            {
                for (i = 1; i <= numPages; i++) {
                    createAnnoLayer(i);
                }
            }

            var createAnnoLayer = function (page)
            {
                var layer = document.getElementById(annoLayerClass + page);
                if (layer == null) {
                    if (document.getElementById('page' + page) == null)
                        return null;

                    var canvas = $('#page' + page);
                    var canvasParent = canvas.parent().parent();
                    var textLayer = canvasParent;//.find('.textLayer');
                    textLayer.append("<div id='" + annoLayerClass + page + "' class='" + annoLayerClass + "' style='top:0px; left:0px; width: 100%; height: 100%; pointer-events:none;position:absolute;'></div>");
                }
                return $('#' + annoLayerClass + page);
            }

            var enableAnnoLayer = function (isEnabled) {

                var event = 'stroke';
                if (!isEnabled)
                    event = 'none';

                $('.' + annoLayerClass).css({ 'pointer-events': event });
            }

            var textMouseClick = function (e) {
                enableAnnoLayer(false);
                svgElement.removeEventListener("click", textMouseClick, true);

                if (toolType == 0) {
                    return;
                }
                toolType = 0;
                var text = '<div class="' + editTextClass + '" id="' + editTextClass + edittextNo + '" contenteditable="true" spellcheck="false" style="left:0px; top:0px; padding: ' + svgPadding + 'px;color:black;pointer-events:stroke;" onclick="annoSelector(' + "'" + editTextClass + edittextNo + "'" + ')">test</div>';
                
                var field = $('#' + svgElement.id).append(text).find('.' + editTextClass);
                field.focus();

                document.getElementById(editTextClass + edittextNo).addEventListener("input", onEditText, false);
                edittextNo++;

                signatureArrange(editTextClass, e.offsetX, e.offsetY);
                
            };

            var signatureMouseClick = function (e) {
                enableAnnoLayer(false);
                svgElement.removeEventListener("click", signatureMouseClick, true);
                if (toolType == 0)
                    return;
                toolType = 0;

                var html = document.getElementById(signatureClass + "-xx").outerHTML;
                html = html.replace(/-xx-/g, signatureNo);
                html = html.replace(/-xx/g, "-" + signatureNo);
                var field = $('#' + svgElement.id).append(html).find('.' + signatureClass);
                field.show();
                signatureNo++;
                signatureArrange(signatureClass, e.offsetX, e.offsetY);
            }

            var signatureArrange = function (theClass, offsetX, offsetY) {
                var field = $('#' + svgElement.id).find('.' + theClass);
                var rect = {
                    top: field[0].offsetTop,
                    left: field[0].offsetLeft,
                    width: field[0].offsetWidth,
                    height: field[0].offsetHeight,
                };

                $('#' + svgElement.id).css({ "width": rect.width + (svgPadding * 2) + 'px' })
                $('#' + svgElement.id).css({ "height": rect.height + (svgPadding * 2) + 'px' });
                if (offsetY != null)
                    $('#' + svgElement.id).css({ 'top': offsetY - svgPadding - (rect.height / 2) + 'px' });
                if (offsetX != null)
                    $('#' + svgElement.id).css({ 'left': offsetX - svgPadding - (rect.width / 2) + 'px' });
                $('#' + svgElement.id).css({ 'pointer-events': 'none' });
            }

            var positionArrange = function (theClass, offsetX, offsetY) {
                var field = $('#' + svgElement.id).find('.' + theClass);
                var rect = field[0].getBoundingClientRect();
                //if (field[0].offsetTop == undefined) {
                //    rect = {
                //        top: field[0].clientTop,
                //        left: field[0].clientLeft,
                //        width: field[0].clientWidth,
                //        height: field[0].clientHeight,
                //    };
                //} else {
                //    rect = {
                //        top: field[0].offsetTop,
                //        left: field[0].offsetLeft,
                //        width: field[0].offsetWidth,
                //        height: field[0].offsetHeight,
                //    };
                //}

                $('#' + svgElement.id).css({ "width": rect.width + (svgPadding * 2) + 'px' })
                $('#' + svgElement.id).css({ "height": rect.height + (svgPadding * 2) + 'px' });
                if (offsetY != null)
                    $('#' + svgElement.id).css({ 'top': offsetY + 'px' });
                if (offsetX != null)
                    $('#' + svgElement.id).css({ 'left': offsetX  + 'px' });
            }

            var initialMouseClick = function (e) {
                enableAnnoLayer(false);
                svgElement.removeEventListener("click", initialMouseClick, true);
                if (toolType == 0)
                    return;
                toolType = 0;

                var html = document.getElementById(initialClass + "-xx").outerHTML;
                html = html.replace(/-xx-/g, initialNo);
                html = html.replace(/-xx/g, "-" + initialNo);
                initialNo++;

                var field = $('#' + svgElement.id).append(html).find('.' + initialClass);
                field.show();
                signatureArrange(initialClass, e.offsetX, e.offsetY);
            }

            var stampMouseClick = function (e) {
                enableAnnoLayer(false);
                svgElement.removeEventListener("click", stampMouseClick, true);

                if (toolType == 0)
                    return;
                toolType = 0;
                var text = '<img class="' + stampClass + '" id="' + stampClass + stampNo + '" src="/images/stamp/empty.png" style="left:0px; top:0px; height:100px; width:200px; padding: ' + svgPadding + 'px;" onclick="annoSelector(' + "'" + stampClass + stampNo + "'" + ')"/>';

                var field = $('#' + svgElement.id).append(text).find('.' + stampClass);
                stampNo++;
                signatureArrange(stampClass, e.offsetX, e.offsetY);
                
            }

            var onEditText = function (e) {
                var w = e.path[0].clientWidth;
                var h = e.path[0].clientHeight;

                $('#' + e.path[1].id).css({ "width": (w + 10) + 'px' })
                $('#' + e.path[1].id).css({ "height": h + 'px' });

                $scope.annoSelectorRemoveEvent();
                $('.svg-selection').hide();
                isresize = false;
            }
            var selectionDblClick = function (e) {
                if (selectedNodeId.startsWith(editTextClass)) {
                    $scope.annoSelectorRemoveEvent();
                    $('.svg-selection').hide();
                    isresize = false;
                    $('#' + selectedNodeId).focus();
                } else if (selectedNodeId.startsWith(signatureClass)) {
                    alert(selectedNodeId)
                } else if (selectedNodeId.startsWith(initialClass)) {
                    alert(selectedNodeId)
                }

            }

            var penMouseDown = function (e) {
                if (toolType == 0)
                    return;

                bufferSize = 4;
                path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", colorDefault);
                path.setAttribute("stroke-width", strokeWidth);
                path.setAttribute("style", "cursor:pointer;pointer-events:stroke;opacity:" + opacityColor);

                buffer = [];
                var pt = getMousePosition(e);
                appendToBuffer(pt);
                strPath = "M" + pt.x + " " + pt.y;
                path.setAttribute("d", strPath);
                svgElement.appendChild(path);
            };

            var penMouseMove = function (e) {
                if (toolType == 0)
                    return;
                if (path) {
                    appendToBuffer(getMousePosition(e));
                    updateSvgPath();
                }
            };

            var penMouseUp = function () {
                enableAnnoLayer(false);
                svgElement.removeEventListener("mousedown", penMouseDown, true);
                svgElement.removeEventListener("mousemove", penMouseMove, true);
                svgElement.removeEventListener("mouseup", penMouseUp, true);
                
                if (toolType == 0)
                    return;
                toolType = 0;
                if (path) {
                    var rc = svgElement.getBoundingClientRect();
                    var rect = path.getBoundingClientRect(); 

                    $('#' + svgElement.id).css({ 'top': rect.top - rc.top - svgPadding + 'px' });
                    $('#' + svgElement.id).css({ 'left': rect.left - rc.left - svgPadding + 'px' });
                    $('#' + svgElement.id).css({ 'width': rect.width + (svgPadding * 2) + 'px' });
                    $('#' + svgElement.id).css({ 'height': rect.height + (svgPadding * 2) + 'px' });
                    $('#' + svgElement.id).css({ 'pointer-events': 'none' });

                    var d = path.attributes['d'].value;
                    var ds = d.split(' ');
                    var newd = "";
                    if (lineStraight && ds.length>4) {
                        ds.splice(2, ds.length-4);
                    } 

                    var xy = 0;
                    for (i = 0; i < ds.length; i++) {
                        var digit1 = "";
                        var value = 0;
                        if ($.isNumeric(ds[i]))
                            value = parseFloat(ds[i]);
                        else {
                            digit1 = ds[i].substring(0, 1);
                            value = parseFloat(ds[i].substring(1));
                        }

                        data = digit1 + ((xy != 0 ? value - (rect.top - rc.top) : value - (rect.left - rc.left)) + svgPadding) + " ";
                        newd += data;
                        if (xy == 0) xy = 1; else xy = 0;
                    }

                    path.setAttribute('d', newd);
                    path.setAttribute('id', penClass + penNo);
                    path.setAttribute('class', penClass);
                    path.setAttribute('onclick', "annoSelector(" + "'" + penClass + penNo + "'" + ")");
                    path = null;
                    penNo++;
                }
            };

            var getMousePosition = function (e) {
                rect = svgElement.getBoundingClientRect();
                return {
                    x: e.pageX - rect.left,
                    y: e.pageY - rect.top
                }
            };

            var appendToBuffer = function (pt) {
                buffer.push(pt);
                while (buffer.length > bufferSize) {
                    buffer.shift();
                }
            };

            // Calculate the average point, starting at offset in the buffer
            var getAveragePoint = function (offset) {
                var len = buffer.length;
                if (len % 2 === 1 || len >= bufferSize) {
                    var totalX = 0;
                    var totalY = 0;
                    var pt, i;
                    var count = 0;
                    for (i = offset; i < len; i++) {
                        count++;
                        pt = buffer[i];
                        totalX += pt.x;
                        totalY += pt.y;
                    }
                    return {
                        x: totalX / count,
                        y: totalY / count
                    }
                }
                return null;
            };

            var updateSvgPath = function () {
                var pt = getAveragePoint(0);

                if (pt) {
                    // Get the smoothed part of the path that will not change
                    strPath += " L" + pt.x + " " + pt.y;

                    // Get the last part of the path (close to the current mouse position)
                    // This part will change if the mouse moves again
                    var tmpPath = "";
                    for (var offset = 2; offset < buffer.length; offset += 2) {
                        pt = getAveragePoint(offset);
                        tmpPath += " L" + pt.x + " " + pt.y;
                    }

                    // Set the complete current path coordinates
                    path.setAttribute("d", strPath + tmpPath);
                }
            };

            $scope.finishLoading = function () {
                var a = pdfjsLib.AnnotationLayer;
                /*const pdfjsLib = require('pdfjs-dist');
                ...
                pdfjsLib.getDocument(pdfPath).then(function (doc) {
                    var numPages = doc.numPages;
                    console.log('# Document Loaded');
                    console.log('Number of Pages: ' + numPages);
                }
                */
                //var numPages=0;
                //pdfjsLib.getDocument(pdfPath).then(function (doc) {
                //    numPages = doc.numPages;
                //});
                //var pg = pdfjsLib.PDFWorker().get
                //var pg=pdfjsLib.getDocument();
                var canvas = $('#page1');
                //alert(pg);
            }

            $scope.selectSignature = function (idx) {
                alert(idx);
            }
            $scope.selectInitial = function (idx) {
                alert(idx);
            }

            function dragElement(elmnt) {
                var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                if (document.getElementById(elmnt.id)) {
                    // if present, the header is where you move the DIV from:
                    document.getElementById(elmnt.id).onmousedown = dragMouseDown;
                } else {
                     //otherwise, move the DIV from anywhere inside the DIV: 
                    elmnt.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    console.log('dragMouseDown clientX: ' + e.clientY + ', clientY: ' + e.clientY);
                    document.onmouseup = closeDragElement;
                    // call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    //console.log(selectedNodeId+' | elementDrag clientX: ' + e.clientY + ', clientY: ' + e.clientY);
                    // set the element's new position:
                    elmnt.style.top = (pos2Float(elmnt.style.top) - pos2) + "px";
                    elmnt.style.left = (pos2Float(elmnt.style.left) - pos1) + "px";
                    console.log(selectedNodeId + ' | elementDrag TOP: ' + (elmnt.offsetTop - pos2) + ', LEFT: ' + (elmnt.offsetLeft - pos1));

                    var selNode = document.getElementById(selectedNodeId);
                    var svg = document.getElementById(selNode.parentNode.id);
                    svg.style.top = (pos2Float(svg.style.top) - pos2) + "px";
                    svg.style.left = (pos2Float(svg.style.left) - pos1) + "px";
                }

                function closeDragElement() {
                    // stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
            /*--------------------------------------------------------------
                END POPUP MEMBER
            --------------------------------------------------------------*/


        });


        $(function () {

        });

        function clickPointer() {
            //var z = pdfjsLib.pageCount;
            //var a = pdfjsLib.AnnotationLayer;
            //var xx=PDFViewerApplication.pdfDocumentProperties;
            //var x = pdfjsLib.PDFDataRangeTransport;
        }

        $(document).ready(function () {
            //$('#checkbox1').bootstrapSwitch();
        })

        function annoSelector(idx) {
            var scope = angular.element(document.getElementById("drdController")).scope();
            scope.$apply(function () {
                scope.annoSelector(idx);
            });
        }
        function selectSignature(idx) {
            var scope = angular.element(document.getElementById("drdController")).scope();
            scope.$apply(function () {
                scope.selectSignature(idx);
            });
        }
        function selectInitial(idx) {
            var scope = angular.element(document.getElementById("drdController")).scope();
            scope.$apply(function () {
                scope.selectInitial(idx);
            });
        }
    </script>

</body>